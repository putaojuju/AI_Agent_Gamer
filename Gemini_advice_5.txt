import customtkinter as ctk
import threading
import queue
import time
from PIL import Image
from datetime import datetime

# å¼•å…¥ä½ çš„æ ¸å¿ƒæ¨¡å—
# from smart_agent import SmartAgent
# from background_windows import BackgroundWindows
# ... (å¼•å…¥å…¶ä»–æ¨¡å—)

ctk.set_appearance_mode("Dark")
ctk.set_default_color_theme("blue")

class AICmdCenter(ctk.CTk):
    def __init__(self):
        super().__init__()
        
        # --- çª—å£åŸºç¡€è®¾ç½® ---
        self.title("AI Agent æŒ‡æŒ¥ä¸­å¿ƒ - Project Daigan")
        self.geometry("1280x800")
        
        # --- æ•°æ®é€šä¿¡ ---
        self.log_queue = queue.Queue()
        self.image_queue = queue.Queue()
        self.agent_running = False
        
        # --- å¸ƒå±€åˆå§‹åŒ– ---
        self.grid_columnconfigure(1, weight=1)
        self.grid_rowconfigure(0, weight=1)
        
        self.init_sidebar()
        self.init_main_area()
        
        # --- å¯åŠ¨ UI æ›´æ–°å¾ªç¯ ---
        self.after(100, self.update_ui_loop)

    def init_sidebar(self):
        """å·¦ä¾§æ§åˆ¶æ """
        self.sidebar = ctk.CTkFrame(self, width=220, corner_radius=0)
        self.sidebar.grid(row=0, column=0, sticky="nsew")
        
        # æ ‡é¢˜
        self.logo_label = ctk.CTkLabel(self.sidebar, text="ğŸ¤– AI COMMANDER", font=ctk.CTkFont(size=20, weight="bold"))
        self.logo_label.pack(padx=20, pady=(20, 10))
        
        # çŠ¶æ€æŒ‡ç¤º
        self.status_label = ctk.CTkLabel(self.sidebar, text="â— IDLE", text_color="gray", font=("Consolas", 14))
        self.status_label.pack(pady=5)
        
        # æ§åˆ¶æŒ‰é’®
        self.btn_start = ctk.CTkButton(self.sidebar, text="å¯åŠ¨ Agent", fg_color="#2EA043", command=self.start_agent)
        self.btn_start.pack(padx=20, pady=10)
        
        self.btn_stop = ctk.CTkButton(self.sidebar, text="ç´§æ€¥åœæ­¢ (F12)", fg_color="#DA3633", command=self.stop_agent)
        self.btn_stop.pack(padx=20, pady=10)
        
        # æ¨¡å¼åˆ‡æ¢
        self.tab_view = ctk.CTkTabview(self.sidebar, height=300)
        self.tab_view.pack(padx=10, pady=20, fill="x")
        self.tab_view.add("ç›‘æ§")
        self.tab_view.add("è®¾ç½®")
        
        # ç›‘æ§Tabå†…çš„å¿«æ·æŒ‡ä»¤
        self.btn_quick1 = ctk.CTkButton(self.tab_view.tab("ç›‘æ§"), text="æµ‹è¯•æˆªå›¾", command=self.test_snapshot)
        self.btn_quick1.pack(pady=5)

    def init_main_area(self):
        """å³ä¾§ä¸»å†…å®¹åŒº"""
        self.main_frame = ctk.CTkFrame(self, fg_color="transparent")
        self.main_frame.grid(row=0, column=1, sticky="nsew", padx=20, pady=20)
        self.main_frame.grid_columnconfigure(0, weight=3) # ç”»é¢å 3ä»½
        self.main_frame.grid_columnconfigure(1, weight=2) # æ—¥å¿—å 2ä»½
        self.main_frame.grid_rowconfigure(0, weight=1)
        
        # 1. è§†è§‰é¢„è§ˆåŒº (The Eye)
        self.preview_frame = ctk.CTkFrame(self.main_frame)
        self.preview_frame.grid(row=0, column=0, sticky="nsew", padx=(0, 10))
        
        self.preview_label = ctk.CTkLabel(self.preview_frame, text="ç­‰å¾…è§†è§‰ä¿¡å·...", corner_radius=10)
        self.preview_label.pack(expand=True, fill="both", padx=10, pady=10)
        
        # 2. æ€ç»´é“¾æ—¥å¿—åŒº (The Mind)
        self.log_frame = ctk.CTkScrollableFrame(self.main_frame, label_text="æ€ç»´é“¾æ—¥å¿— (CoT)")
        self.log_frame.grid(row=0, column=1, sticky="nsew")

    def add_log_card(self, text, type="info"):
        """æ·»åŠ å¡ç‰‡å¼æ—¥å¿—"""
        colors = {
            "thought": ("#1c2e4a", "#3b8ed0"), # æ·±è“èƒŒæ™¯
            "action":  ("#1e3a29", "#2cc985"), # æ·±ç»¿èƒŒæ™¯
            "error":   ("#4a1c1c", "#fa5a5a"), # æ·±çº¢èƒŒæ™¯
            "info":    ("gray20", "gray80")
        }
        bg, fg = colors.get(type, colors["info"])
        
        card = ctk.CTkFrame(self.log_frame, fg_color=bg)
        card.pack(fill="x", pady=2, padx=5)
        
        ts = datetime.now().strftime("%H:%M:%S")
        
        # æ ‡é¢˜è¡Œ
        header = ctk.CTkLabel(card, text=f"[{ts}] {type.upper()}", text_color=fg, font=("Arial", 10, "bold"), anchor="w")
        header.pack(fill="x", padx=5, pady=(5,0))
        
        # å†…å®¹è¡Œ
        content = ctk.CTkLabel(card, text=text, text_color="white", font=("Consolas", 12), justify="left", anchor="w", wraplength=300)
        content.pack(fill="x", padx=5, pady=(0,5))
        
        # è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        self.log_frame._parent_canvas.yview_moveto(1.0)

    def update_image_preview(self, pil_image):
        """æ›´æ–°è§†è§‰é¢„è§ˆï¼Œå¤„ç†å›¾ç‰‡å°ºå¯¸é€‚é…"""
        # è®¡ç®—ç¼©æ”¾
        w_box = self.preview_frame.winfo_width()
        h_box = self.preview_frame.winfo_height()
        
        # ç®€å•çš„ä¿æŒæ¯”ä¾‹ç¼©æ”¾é€»è¾‘ (æ­¤å¤„å¯ä¼˜åŒ–)
        ctk_img = ctk.CTkImage(light_image=pil_image, dark_image=pil_image, size=(w_box-20, h_box-20))
        self.preview_label.configure(image=ctk_img, text="")

    def update_ui_loop(self):
        """UI ä¸»å¾ªç¯ï¼Œå¤„ç†é˜Ÿåˆ—æ¶ˆæ¯"""
        # 1. å¤„ç†æ—¥å¿—
        try:
            while True:
                msg = self.log_queue.get_nowait()
                self.add_log_card(msg['text'], msg['type'])
        except queue.Empty:
            pass
        
        # 2. å¤„ç†å›¾åƒ
        try:
            while True:
                # åªå–æœ€æ–°çš„ä¸€å¼ å›¾ï¼Œä¸¢å¼ƒæ—§çš„ä»¥é˜²å¡é¡¿
                img = self.image_queue.get_nowait()
                if self.image_queue.empty():
                    self.update_image_preview(img)
        except queue.Empty:
            pass
            
        self.after(100, self.update_ui_loop)

    # --- æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘è¿æ¥ ---
    def start_agent(self):
        self.status_label.configure(text="â— RUNNING", text_color="#2cc985")
        self.log_queue.put({"text": "Agent å¯åŠ¨åˆå§‹åŒ–...", "type": "info"})
        # è¿™é‡Œå¯åŠ¨ä½ çš„ agent_core çº¿ç¨‹
        
    def stop_agent(self):
        self.status_label.configure(text="â— STOPPED", text_color="#fa5a5a")
        self.log_queue.put({"text": "ç”¨æˆ·è§¦å‘ç´§æ€¥åœæ­¢", "type": "error"})

    def test_snapshot(self):
        """æµ‹è¯•ç”¨ï¼šæ¨¡æ‹Ÿå‘é€ä¸€å¼ å›¾ç‰‡"""
        # å®é™…ä»£ç ä¸­ï¼Œä½ åº”è¯¥åœ¨ SmartAgent.step é‡Œè°ƒç”¨ queue.put
        self.log_queue.put({"text": "æ­£åœ¨è·å–å±å¹•æˆªå›¾...", "type": "thought"})
        self.log_queue.put({"text": "è¯†åˆ«åˆ°ç›®æ ‡ï¼š'å¼€å§‹æ¸¸æˆ' (0.85)", "type": "action"})
        
        # æ¨¡æ‹Ÿç”Ÿæˆä¸€å¼ çº¢å›¾
        img = Image.new('RGB', (800, 450), color = (73, 109, 137))
        self.image_queue.put(img)

if __name__ == "__main__":
    app = AICmdCenter()
    app.mainloop()