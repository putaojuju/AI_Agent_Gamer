📋 Project Daigan 重构与升级执行计划 (v2.1 - 修正版)
🔴 阶段 0：紧急修复与清理 (基建稳固)
目标：修复因架构调整导致的引用错误，确保 main.py 能成功启动新版 SmartAgent。
修复 smart_agent.py：
删除所有对 ocr_tool 的引用和实例化。
删除 _convert_ocr_to_window_coords 方法。
保留 _convert_ratio_to_window_coords 方法。
修改构造函数：增加 knowledge_base 参数。
任务：确保初始化仅依赖 bg_windows, ai_brain, ui_queue, img_queue, knowledge_base。
修复 main.py (原 AICmdCenter)：
定位：start_agent 方法。
修改：
在实例化 SmartAgent 之前，先初始化 KnowledgeBase 并加载当前选择的游戏。
移除对旧模块（如 agent_core）的任何潜在引用。
实例化 SmartAgent 时，传入新增的 knowledge_base 参数。
依赖清理：
清理 requirements.txt。
新增依赖：imagehash。
🟡 阶段 1：大脑升级 (VLM + 网格定位)
目标：让 AI 通过网格看图，不再依赖 OCR 找坐标。
改造 ai_brain.py：
实现 _add_grid_overlay(image)：
绘制 10x10 红线网格。
在边缘标注 0.1, 0.2... 坐标刻度。
JSON 容错解析：
在 _parse_json_response 中增加逻辑：使用正则表达式提取 ```json ... ``` 代码块中的内容，防止 Markdown 格式导致解析失败。
重写 System Prompt：
要求输出 JSON：{ "scene_summary": "...", "elements": [...] }。
强调参考红色网格线估算坐标。
🟢 阶段 2：构建“UI 图谱” (缓存系统)
目标：建立本地视觉指纹库，实现“一次识别，永久复用”。
创建 knowledge/ui_atlas_manager.py：
实现 UIAtlasManager 类。
抗干扰优化：
在 compute_fingerprint 中，增加 mask 或 crop 参数，仅计算屏幕中心区域或上半部分区域的 pHash，避开右下角可能存在的动态 Banner/跑马灯干扰。
实现 match_scene (对比汉明距离) 和 register_scene。
定义数据结构 (ui_atlas.json)：
存储 scene_id, phash, elements。
🔵 阶段 3：核心循环重构 (快慢系统)
目标：整合缓存查表与 AI 分析。
重构 smart_agent.py 的 step 方法：
Step 1 (定位)：截屏 -> 计算 pHash -> 查询 UIAtlasManager。
Step 2 (决策)：
Hit (快系统)：缓存命中 -> 直接取坐标 -> (可选：局部色块校验) -> 点击。
Miss (慢系统)：调用 ai_brain (带网格) -> 执行操作 -> 异步写入缓存。
自愈机制：
操作后画面未变 -> 判定缓存失效 -> 删除对应指纹 -> 强制重走慢系统。
🟣 阶段 4：交互优化 (可选)
main.py UI 增强：
在 AICmdCenter 增加状态指示灯（Green/Blue/Yellow）显示当前是“缓存模式”还是“思考模式”。
给 Trae 的指令：
“Trae，之前的 agent_console.py 是旧文件，请忽略。
请按照这份 v2.1 修正版执行计划 进行操作。
重点修正：
所有 UI 层的修复工作都在 main.py 中进行。
在 阶段 2 实现 pHash 时，请务必加上区域裁剪（Crop）逻辑，只计算 UI 固定区域的指纹，避开游戏里的动态 Banner。
在 阶段 1 的 ai_brain.py 中增加 JSON 解析的正则表达式容错。
请从阶段 0 开始。”